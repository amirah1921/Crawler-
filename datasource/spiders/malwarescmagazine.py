import scrapy
from newspaper import Article
from datasource.items import DatasourceItem

class MalwarescmagazineSpider(scrapy.Spider):
    name = "malwarescmagazine"
    custom_settings = {'ROBOTSTXT_OBEY': False}
    allowed_domains = ["www.scmagazine.com"]
    start_urls = ["https://www.scmagazine.com/topic/malware"]

    def parse(self, response):
        news_articles = response.xpath('//div[@class="teaser-list-wrapper"]/article')
        for article in news_articles:
            title = article.css('h5.font-heading::text').get()
            url = article.css('a::attr(href)').get()
            postedDate = article.css('time.non-interactive::text').get()
            
            yield response.follow(url, callback=self.parse_article, meta={
                'title': title,
                'postedDate': postedDate,
            })

        next_page_url = response.css('a[rel="next"]::attr(href)').get()
        if next_page_url:
            yield scrapy.Request(url=response.urljoin(next_page_url), callback=self.parse)

    def parse_article(self, response):
        article = Article(response.url, language='en')
        article.download()
        article.parse()

        yield {
            'title': response.meta['title'],
            'postedDate': response.meta['postedDate'],
            'url': article.url,
            'author': article.authors,
            'articleText': article.text,
        }